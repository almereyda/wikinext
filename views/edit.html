<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/html">
<head>
<title>{{title}}</title>
<link href="/css/bootstrap.min.css" rel="stylesheet">
<!--<script type="text/javascript" src="/nowjs/now.js"></script>-->
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/ICanHaz.min.js"></script>
<script type="text/javascript" src="/js/jsdeferred.js"></script>
<script type="text/javascript" src="/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/underscore-min.js"></script>
<script type="text/javascript" src="/js/backbone-min.js"></script>
<script type="text/javascript" src="/js/wikinext.helper.js"></script>
<!--<script type="text/javascript" src="/js/wikinext.main.js"></script>-->
<script type="text/javascript" src="/codemirror/codemirror.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/channel/bcsocket.js"></script>
<script src="/share/share.js"></script>
<script src="/js/codemirror_sharejs.js"></script>
<link rel="stylesheet" href="/codemirror/codemirror.css">
<script src="/codemirror/mode/javascript/javascript.js"></script>
<script src="/codemirror/mode/css/css.js"></script>
<script src="/codemirror/mode/xml/xml.js"></script>
<script src="/codemirror/mode/htmlmixed/htmlmixed.js"></script>
<script type="text/javascript">
    wikinextHelper.init();
    Deferred.parallel({
        messageSuccess:wikinextHelper.http_get("/templates/messageSuccess.html"),
        messageFail:wikinextHelper.http_get("/templates/messageFail.html")
    }).next(function (data) {
                ich.addTemplate("messageSuccess", data.messageSuccess);
                ich.addTemplate("messageFail", data.messageFail);
                console.log("templates loaded");
            });
</script>
<style>

    body {
        padding-top: 100px;
        padding-bottom: 40px;
    }

    #filedrag
    {
        display: none;
        font-weight: bold;
        text-align: center;
        padding: 1em 0;
        margin: 1em 0;
        color: #555;
        border: 2px dashed #555;
        border-radius: 7px;
        cursor: default;
    }

    #filedrag.hover
    {
        color: #f00;
        border-color: #f00;
        border-style: solid;
        box-shadow: inset 0 3px 4px #888;
    }

    #preview {
        border: 0px
    }

</style>
<script type="text/javascript">



    var page = {
        _id: "{{#page}}{{_id}}{{/page}}"
    };

    var editorHTML;var editorJavaScript;

    $(document).ready(function(){

        (function() {
            // getElementById
            function $id(id) {
                return document.getElementById(id);
            }
            // output information
            function Output(msg) {
                var m = $id("messages");
                m.innerHTML = msg + m.innerHTML;
            }
            // file drag hover
            function FileDragHover(e) {
                e.stopPropagation();
                e.preventDefault();
                e.target.className = (e.type == "dragover" ? "hover" : "");
            }
            // file selection
            function FileSelectHandler(e) {

                // cancel event and hover styling
                FileDragHover(e);

                // fetch FileList object
                var files = e.target.files || e.dataTransfer.files;

                // process all File objects
                for (var i = 0, f; f = files[i]; i++) {
                    ParseFile(f);
                    UploadFile(f);
                }

            }
            // output file information
            function ParseFile(file) {
                Output(
                        "<p>File information: <strong>" + file.name +
                                "</strong> type: <strong>" + file.type +
                                "</strong> size: <strong>" + file.size +
                                "</strong> bytes</p>"
                );
                // display an image
                if (file.type.indexOf("image") == 0) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        Output(
                                "<p><strong>" + file.name + ":</strong><br />" +
                                        '<img src="' + e.target.result + '" /></p>'
                        );
                    };
                    reader.readAsDataURL(file);
                }

                // display text
                if (file.type.indexOf("text") == 0) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        Output(
                                "<p><strong>" + file.name + ":</strong></p><pre>" +
                                        e.target.result.replace(/</g, "&lt;").replace(/>/g, "&gt;") +
                                        "</pre>"
                        );
                    };
                    reader.readAsText(file);
                }
            }


            // upload JPEG files
            function UploadFile(file) {

                var xhr = new XMLHttpRequest();
                console.log(file);
                if (xhr.upload && (file.type == "image/jpeg" || file.type == "image/gif" || file.type == "image/png") && file.size <= $id("MAX_FILE_SIZE").value) {
                    console.log("upload");
                    // create progress bar
                    var o = $id("progress");
                    var progress = o.appendChild(document.createElement("p"));
                    progress.appendChild(document.createTextNode("upload " + file.name));


                    // progress bar
                    xhr.upload.addEventListener("progress", function(e) {
                        var pc = parseInt(100 - (e.loaded / e.total * 100));
                        progress.style.backgroundPosition = pc + "% 0";
                    }, false);

                    // file received/failed
                    xhr.onreadystatechange = function(e) {
                        if (xhr.readyState == 4) {
                            progress.className = (xhr.status == 200 ? "success" : "failure");
                        }
                    };

                    // start upload
                    xhr.open("POST", $id("upload").action, true);
                    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                    xhr.setRequestHeader("x-file-name", encodeURIComponent(file.name));
                    xhr.setRequestHeader("x-file-type", file.type);
                    xhr.setRequestHeader("x-file-size", file.size);
                    xhr.setRequestHeader("x-page-id", page._id);
                    xhr.setRequestHeader("Content-Type", "application/octet-stream");
                    xhr.send(file);

                }

            }


            // initialize
            function Init() {

                var fileselect = $id("fileselect"),
                        filedrag = $id("filedrag"),
                        submitbutton = $id("submitbutton");

                // file select
                fileselect.addEventListener("change", FileSelectHandler, false);

                // is XHR2 available?
                var xhr = new XMLHttpRequest();
                if (xhr.upload) {

                    // file drop
                    filedrag.addEventListener("dragover", FileDragHover, false);
                    filedrag.addEventListener("dragleave", FileDragHover, false);
                    filedrag.addEventListener("drop", FileSelectHandler, false);
                    filedrag.style.display = "block";

                    // remove submit button
                    submitbutton.style.display = "none";
                }

            }

            // call initialization file
            if (window.File && window.FileList && window.FileReader) {
                Init();
            }


        })();

        (function () {
            var dragZone = document.querySelector('#tab_2');
            var dropZone = document.querySelector('#tab1');
            dragZone.addEventListener('dragstart', function (event) {
//                if (event.target.className) { // img case
                event.dataTransfer.setData("text", '<img src="' + event.target.src + '">');
                //event.dataTransfer.effectAllowed = event.target.className;
                //event.target.style.border = "4px solid #cc3300";
//                } else { // text case
                //if (event.target.parentNode.className == 'overwrite') {
                //event.dataTransfer.setData("text", "<strong>Overwritten Content</strong>");
                //}
                //event.target.parentNode.style.border = "4px solid #cc3300";
//                }
                return true;
            }, true);

            dragZone.addEventListener('dragend', function (event) {
//                if (event.target.className) { // img case
//                    event.target.style.border = "4px solid #888";
//                } else { // text case
//                    event.target.parentNode.style.border = "4px solid #888";
//                }
                return true;
            }, true);

            dropZone.addEventListener('dragenter', function (event) {
                if (event.preventDefault) event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
//                this.className = 'hovering';
                return false;
            }, false);

            dropZone.addEventListener('dragover', function (event) {
                if (event.preventDefault) event.preventDefault(); // allows us to drop
                event.dataTransfer.dropEffect = 'copy';
                return false;
            }, false);

            dropZone.addEventListener('dragleave', function (event) {
                if (event.preventDefault) event.preventDefault(); // allows us to drop
//                this.className = '';
                return false;
            }, false);

            dropZone.addEventListener('drop', function (event) {
                if (event.preventDefault) event.preventDefault();
                var imgPassed = null;
                //var dropdata = document.querySelector('#drop-data');
                var types = event.dataTransfer.types;
//                document.querySelector('#drop-data').textContent = '';
//                this.innerHTML = '';
//                for (var i = 0; i < types.length; i++) {
//                    if (types[i] == 'Files') {
//                        var files = event.dataTransfer.files;
//                        for (var j = 0; j < files.length; j++) {
//                            dropdata.textContent += 'File Name: '+files[j].fileName;
//                            dropdata.textContent += 'File Size: '+files[j].fileSize;
//                        }
//                    } else {
//                        if (typeof event.dataTransfer.getData(types[i]) !== 'undefined') {
//                            dropdata.innerHTML += '<p><em class="datatypes">'+types[i]+'</em>: <br />'+event.dataTransfer.getData(types[i]).replace(/</g, '&lt;') + '</p>';
//                        }
//                    }
//
//                    if (types[i] == 'text/uri-list') {
//                        imgPassed = event.dataTransfer.getData('text/uri-list');
//                    }
//                }

//                if (imgPassed) {
//                    var cEl = document.createElement('canvas');
//                    cEl.width = 200;
//                    cEl.height = 100;
//                    var ctx = cEl.getContext('2d');
//                    var img_buffer = document.createElement('img');
//                    img_buffer.src = imgPassed;
//                    img_buffer.style.display = 'none';
//                    document.body.appendChild(img_buffer); // this line only needed in safari
//                    img_buffer.onload = function() { ctx.drawImage(img_buffer,0,0,100,100); }
//                    this.appendChild(cEl);
//                } else {
                var text = "";
                if (event.dataTransfer.getData('text')) {
                    text = event.dataTransfer.getData('text');
                } else if (event.dataTransfer.getData('text/plain')) {
                    text = event.dataTransfer.getData('text/plain');
                }
                editorHTML.replaceSelection(text);
//                }
                return false;
            }, false);
        })();

        editorHTML = CodeMirror.fromTextArea(document.getElementById("textAreaArticle"),{
            mode: "text/html",
            tabMode: "indent",
            lineWrapping: true
        });

        $("#save_button").click(function(){
            $.post("/wiki/"+page._id+"/save",{
                title: $("#page_title").val(),
                article: editorHTML.getValue(),
                app: editorJavaScript.getValue()
            },function(d){

                var m;
                if (d.status == 'ok'){
                    m = ich.messageSuccess({"message": "Page has been saved"});

                } else {
                    m = ich.messageFail({"message": "Page has not been saved"});
                }
                $(m).insertBefore("#main_page_module .tabbable");
            });
        });

        $("#update_title").click(function(e){
            $.post("/wiki/"+page._id+"/save",{title: $("#page_title").val()},function(){})
        });

        editorJavaScript = CodeMirror.fromTextArea(document.getElementById("textAreaApplication"),{
            mode: "javascript",
            tabMode: "indent",
            lineNumbers: true,
            lineWrapping: true
        });

        sharejs.open(page._id, 'text', function(error, doc) {
            doc.attach_codemirror(editorHTML,true);
        });

        sharejs.open(page._id+"app", 'text', function(error, doc) {
            doc.attach_codemirror(editorJavaScript,true);
        });

//        editorHTML.refresh();
//        editorJavaScript.refresh();

        $("#create-page-button").click(function () {
            $('#create-page').modal('hide');
            $("#create-page-form").submit();
        });


        $('#edit_tabs a').on('shown', function (e) {
            console.log($(e.target).data('id'));
            if ($(e.target).data('id') == 'html'){
                editorHTML.refresh();
//                sharejs.open(page._id+"js", 'text', function(error, doc) {
//                    doc.detach_codemirror();
//                });
//                sharejs.open(page._id, 'text', function(error, doc) {
//                    doc.attach_codemirror(editorHTML,true);
//                });
            } else {
                editorJavaScript.refresh();
//                sharejs.open(page._id, 'text', function(error, doc) {
//                    doc.detach_codemirror();
//                });
//                sharejs.open(page._id+"js", 'text', function(error, doc) {
//                    doc.attach_codemirror(editorJavaScript,true);
//                });
            }
        });

        $(".deleteattach").click(function(){

            var self = this;
            $.post("/deleteattach",{
                index:$(self).data("id"),
                pageid:page._id
                }, function(data){
                    //console.log(data);
                    var m;
                    if (data.status == 'ok'){
                        $(self).closest("div").remove();
                        m = ich.messageSuccess({"message": "Attach file has been removed"});
                    }
                    else
                        m = ich.messageFail({"message": "Attach file has not been removed"});
                    $(m).insertBefore("#attached_images");
            })
        });

        $("#update_preview_button").click(function(){
            ich.addTemplate("preview",editorHTML.getValue());
            //need to use the same javascript wrapper as wiki.html uses
            var preview = ich.preview(editorJavaScript.getValue());
            $("#preview").empty();$("#preview").append(preview);
        });
    });

</script>
</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a class="brand" href="/">WikiNEXT</a>
            <div class="btn-group pull-right">
                {{#login}}
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="icon-user"></i> Login
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    <li><a href="/auth/facebook">Facebook</a></li>
                </ul>
                {{/login}}
                {{#auth}}
                {{#facebook}}
                {{#user}}
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="icon-user"></i> {{name}}
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    <li><a href="#">Profile</a></li>
                    <li class="divider"></li>
                    <li><a href="/logout">Sign Out</a></li>
                </ul>
                {{/user}}
                {{/facebook}}
                {{/auth}}

            </div>
            <div class="nav-collapse">
                <ul class="nav">
                    <li><a href="/">Home</a></li>
                    <li><a data-toggle="modal" href="#create-page-dialog">Create Page</a></li>
                    <li class="active"><a href="#">Edit</a></li>
                    {{#page}}
                    <li><a href="/wiki/{{_id}}">View</a></li>
                    {{/page}}
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </div>

    <div class="btn-toolbar">
        <div class="btn-group">
            <a class="btn" id="save_button">Save</a>
        </div>
        <div class="btn-group">
            <button class="btn">Heading</button>
            <button class="btn dropdown-toggle" data-toggle="dropdown">
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <!-- dropdown menu links -->
                <a href="#">Heading 1</a>
                <a href="#">Heading 2</a>
                <a href="#">Heading 3</a>
                <a href="#">Heading 4</a>
            </ul>
        </div>
        <div class="btn-group">
            <a class="btn" href="#"><i class="icon-align-left"></i></a>
            <a class="btn" href="#"><i class="icon-align-center"></i></a>
            <a class="btn" href="#"><i class="icon-align-right"></i></a>
            <a class="btn" href="#"><i class="icon-align-justify"></i></a>
        </div>
        <div class="btn-group pull-right">
                <div class="controls">
                    <div class="input-append">
                        {{#page}}
                        <input class="span2" id="page_title" size="16" type="text" value="{{title}}"><button class="btn" type="button" id="update_title">Update</button>
                        {{/page}}
                    </div>
                </div>
        </div>
    </div>
</div>



<div class="container-fluid">
    <div class="row-fluid">
        <div class="span7" id="main_page_module">
            {{#page}}
            <div class="tabbable">
                <ul class="nav nav-tabs" id="edit_tabs">
                    <li class="active"><a href="#tab1" data-toggle="tab" data-id="html">HTML</a></li>
                    <li><a href="#tab_apps" data-toggle="tab" data-id="javascript">JavaScript</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="tab1">
                        <p><textarea id="textAreaArticle" style="visibility: hidden;">{{article}}</textarea></p>
                    </div>
                    <div class="tab-pane" id="tab_apps">
                        <p><textarea id="textAreaApplication" style="visibility: hidden;">{{app}}</textarea></p>
                    </div>
                </div>
            </div>
            {{/page}}
        </div>
        <div class="span5">
            <a href="#" class="btn" id="update_preview_button">Update Preview</a><hr>
            <div id="preview">

            </div>
        </div>
    </div><!--/row-->

    <hr>
    <div class="row-fluid">
    <div class="tabbable">
        <ul class="nav nav-tabs">
            <li class="active"><a href="#tab_1" data-toggle="tab">Attach Files</a></li>
            <li><a href="#tab_2" data-toggle="tab">Attached Files</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" id="tab_1">
                <p><form id="upload" action="/upload" method="POST" enctype="multipart/form-data">
                <fieldset>
                    <input type="hidden" id="MAX_FILE_SIZE" name="MAX_FILE_SIZE" value="300000">

                    <div class="control-group">
                        <label for="fileselect" class="control-label">Files to upload:</label>
                        <input type="file" id="fileselect" name="fileselect[]" multiple="multiple">
                        <div id="filedrag" style="display: block; ">or drop files here</div>
                    </div>

                    <div id="submitbutton" style="display: none; ">
                        <button type="submit">Upload Files</button>
                    </div>

                </fieldset>

            </form>
                <div id="progress"></div>
                <div id="messages">
                    <p>Status Messages</p>
                </div>
            </div>
            <div class="tab-pane" id="tab_2">
                <p id="attached_images">
                    {{#page}}
                    {{#attach}}
                    <div data-id="{{index}}">
                    <span class="label label-info">{{name}} : {{type}} was uploaded by {{uploaded_by}} at {{uploaded_at}}</span><br />
                        <img src='/{{path}}/{{name}}' draggable="true"> <br /><button class="btn btn-danger deleteattach" data-id="{{index}}">Delete {{name}}</button><hr />
                    </div>
                    {{/attach}}
                    {{/page}}
                </p>
            </div>
        </div>
    </div>


    </div>

    <hr>

    <footer><p>WikiNEXT © Pavel Arapov</p></footer>

</div>

<div class="modal hide" id="create-page-dialog">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Create Page</h3>
    </div>
    <div class="modal-body">
        <form id="create-page-form" method="POST" action="/create">
            <label>Create Page</label>
            <input type="text" class="span3" placeholder="Type the name…" id="page_name" name="page_name">
        </form>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
        <a href="#" class="btn btn-primary" id="create-page-button">Create</a>
    </div>
</div>

</body>
</html>