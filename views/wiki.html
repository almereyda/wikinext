<!DOCTYPE HTML>
<html>
<head>
    <title>{{title}}</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="/nowjs/now.js"></script>
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/ICanHaz.min.js"></script>
    <script type="text/javascript" src="/js/jsdeferred.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/js/underscore-min.js"></script>
    <script type="text/javascript" src="/js/backbone-min.js"></script>
    <script type="text/javascript" src="/js/wikinext.main.js"></script>
    <script type="text/javascript" src="/js/rgraph/RGraph.common.core.js"></script>
    <script type="text/javascript" src="/js/rgraph/RGraph.line.js"></script>
    <script type="text/javascript" src="/js/sparql.js"></script>
    <!--[if lt IE 9]><script src="/js/excanvas/excanvas.js"></script><![endif]-->
    <style>

        body {
            padding-top: 100px;
            padding-bottom: 40px;
        }

        #filedrag
        {
            display: none;
            font-weight: bold;
            text-align: center;
            padding: 1em 0;
            margin: 1em 0;
            color: #555;
            border: 2px dashed #555;
            border-radius: 7px;
            cursor: default;
        }

        #filedrag.hover
        {
            color: #f00;
            border-color: #f00;
            border-style: solid;
            box-shadow: inset 0 3px 4px #888;
        }

    </style>
    <script type="text/javascript">
            window.launch_wiki_script = (function(){
                var __data = {"app_name": "Graph example"};
                var application = (function(){
                    {{#page}}
                    {{{app}}}
                    {{/page}}
                    return {
                        __construct: function() {
                            //console.log(this);
                            //console.log(data);
                            if (typeof construct == 'function'){
                                console.log('application construct');
                                __data = construct();
                            } else
                            if (typeof data != 'undefined')
                                __data = data;
                            return __data;
                        },
                        __afterConstruct: function() {
                            if (typeof afterConstruct == 'function'){
                                console.log('application after construct');
                                afterConstruct();
                            }
                        }
                    }})();
                return {
                    construct: function(){
                        return application.__construct();
                    },
                    afterConstruct: function(){
                        application.__afterConstruct();
                    }
                };
            })();
    </script>
    <script type="text/javascript">
        var page = {
            _id: "{{#page}}{{_id}}{{/page}}"
        };

        $(document).ready(function(){
            var data = launch_wiki_script.construct();
            var article = ich.article_template(data);
            $("#article_show").append(article);
            launch_wiki_script.afterConstruct();

                $("body").find('[data-wikinext]').each(function(){

                    var dom_element = this;
                    //all items for macros replace/content augmentation
                    //content (find all headers and construct anchors before them and list with links to it
                    var ul = null;
                    var lasth1 = null;
                    var lasth1ul = null;
                    var lasth2 = null;
                    var lasth2ul = null;

                    $("h1, h2, h3").each(function() {

                        switch (this.tagName.toLowerCase()) {
                            case "h1":
                                if (!ul) {
                                    ul = $("<ul>");
                                }
                                lasth1 = $("<li>").html($(this).html()).appendTo(ul);
                                break;
                            case "h2":
                                if (!lasth1) {
                                    // Deal with invalid condition, h2 with no h1 before it
                                }
                                else {
                                    if (!lasth1ul) {
                                        lasth1ul = $("<ul>").appendTo(lasth1);
                                    }
                                    lasth2 = $("<li>").html($(this).html()).appendTo(lasth1ul);
                                }
                                break;
                            case "h3":
                                if (!lasth2) {
                                    // Deal with invalid condition, h3 with no h2 before it
                                }
                                else {
                                    if (!lasth2ul) {
                                        lasth2ul = $("<ul>").appendTo(lasth2);
                                    }
                                    $("<li>").html($(this).html()).appendTo(lasth2ul);
                                }
                                break;
                        }

                    });
                    if (ul) {
                        dom_element.append(ul);
                    }
                });

        });
    </script>
    <script type="text/html" id="article_template">
        {{#page}}
            {{{article}}}
        {{/page}}
    </script>
</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a class="brand" href="/">WikiNEXT</a>
            <div class="btn-group pull-right">
                {{#login}}
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="icon-user"></i> Login
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    <li><a href="/auth/facebook">Facebook</a></li>
                </ul>
                {{/login}}
                {{#auth}}
                {{#facebook}}
                {{#user}}
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="icon-user"></i> {{name}}
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    <li><a href="#">Profile</a></li>
                    <li class="divider"></li>
                    <li><a href="/logout">Sign Out</a></li>
                </ul>
                {{/user}}
                {{/facebook}}
                {{/auth}}

            </div>
            <div class="nav-collapse">
                <ul class="nav">
                    <li><a href="/">Home</a></li>
                    {{#auth}}
                    {{#facebook}}
                    {{#user}}
                    <li><a data-toggle="modal" href="#create-page-dialog">Create Page</a></li>
                    {{#page}}
                    <li><a href="/wiki/{{_id}}/edit">Edit</a></li>
                    <li><a href="/wiki/{{_id}}/clone">Clone</a></li>
                    {{/page}}
                    {{/user}}
                    {{/facebook}}
                    {{/auth}}
                    <li><a href="/search">Search</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </div>
    <ul class="breadcrumb">
        <li>
            <a href="/">Home</a> <span class="divider">/</span>
        </li>
        {{#page}}
        {{#nav}}
        <li>
            <a href="/wiki/{{_id}}">{{title}}</a> <span class="divider">/</span>
        </li>
        {{/nav}}
        {{/page}}
        {{#page}}
        <li class="active">{{title}}</li>
        {{/page}}
    </ul>
</div>

<div class="container-fluid">
    <div class="row-fluid">
    <div class="span3">
        <div class="well sidebar-nav">
            <ul class="nav nav-list">
                <li class="nav-header">Subpages</li>
                {{#pages}}
                <li><a href="/wiki/{{_id}}">{{title}}</a></li>
                {{/pages}}
            </ul>
        </div><!--/.well -->
    </div><!--/span-->
    <div class="span9" id="article_show">


    </div><!--/row-->
    </div>
    <hr>

    <div class="row-fluid">
        <p>
            <b>Attached files</b><br />
            {{#page}}
            {{#attach}}
            {{name}} : {{type}}
            <img src='/{{path}}/{{name}}'><br />
            {{/attach}}
            {{/page}}
        </p>
    </div>
    <p>Tags:
        <a href="#"><span class="label label-info">Tag</span></a>
        <a href="#"><span class="label label-info">Tag</span></a>
        <a href="#"><span class="label label-info">Tag</span></a>
        <a href="#"><span class="label label-info">Tag</span></a>
        {{#page}}
        | <i class="icon-user"></i> <a href="#">{{created_by}}</a>
        | <i class="icon-calendar"></i> {{created_at}}
        {{#last_modified_by}}
        | <i class="icon-user"></i> <a href="#">{{last_modified_by}}</a>
        | <i class="icon-calendar"></i> {{last_modified_at}}
        {{/last_modified_by}}
        | <i class="icon-comment"></i> <a href="#">3 Comments</a>
        | <i class="icon-share"></i> <a href="#">39 Shares</a>
        {{/page}}
    </p>
    <blockquote class="pull-right">
        <small>Keep do it</small>
    </blockquote>

    <hr>

    <footer><p>WikiNEXT © Pavel Arapov</p></footer>

</div>

<div class="modal hide" id="create-page-dialog">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">×</button>
        <h3>Create Page</h3>
    </div>
    <div class="modal-body">
        <form id="create-page-form" method="POST" action="/create">
            <label>Create Page</label>
            <input type="text" class="span3" placeholder="Type the name…" id="page_name" name="page_name">
            <input type="hidden" name="parent" value="{{#page}}{{_id}}{{/page}}">
        </form>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
        <a href="#" class="btn btn-primary" id="create-page-button">Create</a>
    </div>
</div>

</body>
</html>